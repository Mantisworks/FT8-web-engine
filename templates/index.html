<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>IZ7ZKR - G90 FT8 Web Monitor</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #050505; color: #eee; margin: 0; overflow: hidden; }
        header { background: #111; padding: 12px 20px; border-bottom: 2px solid #00ff00; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1rem; color: #00ff00; letter-spacing: 1px; }
        #user-count { font-size: 0.9rem; color: #888; }
        .green { color: #00ff00; font-weight: bold; }

        #wf-container { width: 100%; height: 260px; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        .table-container { height: calc(100vh - 320px); overflow-y: auto; padding: 10px; }
        table { width: 100%; border-collapse: collapse; background: #0c0c0c; }
        th { background: #1a1a1a; color: #00ff00; padding: 10px; font-size: 0.8rem; position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid #1a1a1a; text-align: center; font-family: 'Consolas', monospace; font-size: 0.9rem; }
        
        .cq-row { color: #00ff00 !important; background: rgba(0, 255, 0, 0.05); }
        .flash { animation: highlight 0.8s ease-out; }
        @keyframes highlight { from { background: #004400; } to { background: transparent; } }
    </style>
</head>
<body>

<header>
    <h1>IZ7ZKR // G90 FT8 ENGINE</h1>
    <div id="user-count">Connessi: <span class="green" id="count-val">0</span></div>
</header>

<div id="wf-container">
    <canvas id="waterfall"></canvas>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>UTC</th>
                <th>CALLSIGN</th>
                <th>SNR</th>
                <th>HZ</th>
                <th>MESSAGE</th>
            </tr>
        </thead>
        <tbody id="msg_body"></tbody>
    </table>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('waterfall');
    const ctx = canvas.getContext('2d');
    const msgBody = document.getElementById('msg_body');

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = 260;
    }
    window.onresize = resize;
    resize();

    socket.on('user_count', (data) => {
        document.getElementById('count-val').innerText = data.count;
    });

    // Waterfall Ottimizzato per fluiditÃ  (Rendering leggero)
    socket.on('wf_data', (data) => {
        const w = canvas.width;
        const h = canvas.height;
        ctx.drawImage(canvas, 0, 0, w, h, 0, 1, w, h);

        const step = w / data.length;
        for (let i = 0; i < data.length; i++) {
            const v = data[i];
            if (v > 15) { // Filtro rumore base per velocizzare
                let r=0, g=0, b=0;
                if (v < 70) b = v * 3;
                else if (v < 170) { g = v; b = 255 - v; }
                else { r = v; g = v; b = v/2; }
                
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fillRect(Math.floor(i * step), 0, Math.ceil(step), 1);
            }
        }
    });

    socket.on('new_msg', (data) => {
        let row = document.getElementById('row_' + data.call);
        if (!row) {
            row = document.createElement('tr');
            row.id = 'row_' + data.call;
        }
        
        row.className = data.msg.includes("CQ") ? "cq-row flash" : "flash";
        row.innerHTML = `
            <td>${data.time}</td>
            <td class="green">${data.call}</td>
            <td>${data.snr}</td>
            <td>${data.freq}</td>
            <td style="text-align:left">${data.msg}</td>
        `;
        msgBody.prepend(row);
        setTimeout(() => row.classList.remove('flash'), 800);
    });
</script>

</body>
</html>